rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Match any file within the 'attachments' directory.
    // The {taskId} and {filename} are wildcards that capture parts of the path.
    match /attachments/{taskId}/{filename} {
    
      // Allow files to be read by anyone. This is standard if you intend for
      // the attachment URLs to be shared or displayed publicly in your app.
      allow read;

      // Allow files to be written (uploaded) only if the user is authenticated (logged in).
      // This is the crucial fix. It provides a baseline of security by ensuring only
      // app users can upload, preventing anonymous uploads.
      // The application's UI logic is responsible for ensuring users only upload to tasks
      // they have access to.
      allow write: if request.auth != null;
    }
  }
}
